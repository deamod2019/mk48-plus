name: Build and Release

# 触发规则：
# 1. 推送 v 开头的标签（如 v1.0.0）时触发正式发布
# 2. 手动点击按钮触发测试
on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

# 必须赋予写权限，否则无法上传 Release
permissions:
  contents: write

jobs:
  build-and-release:
    name: Build & Release Package
    runs-on: ubuntu-latest

    steps:
      # --- 1. 环境准备 ---
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: Install Rust Toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly-2022-08-14
          override: true
          components: rust-src, rustfmt, clippy
          target: x86_64-unknown-linux-gnu

      - name: Install Trunk
        uses: jetli/trunk-action@v0.1.0
        with:
          version: 'v0.15.0'

      # --- 2. 执行构建 ---
      
      # 构建游戏客户端 (WASM)
      - name: Build Game Client
        working-directory: ./client
        run: trunk build --release

      # 构建管理后台 (JS)
      - name: Build Admin Panel
        working-directory: ./engine/js
        run: npm install && npm run build

      # 构建服务端 (Rust Binary)
      - name: Build Server
        run: cargo build --release --manifest-path server/Cargo.toml

      # --- 3. 打包整理 ---
      
      - name: Package Artifacts
        run: |
          echo "正在整理文件..."
          # 创建发布目录结构
          mkdir -p release_package/public
          mkdir -p release_package/admin_ui
          
          # A. 复制服务端程序
          cp target/release/server release_package/mk48-server
          chmod +x release_package/mk48-server
          
          # B. 复制客户端资源 (Web)
          # 注意：trunk build 默认输出到 dist
          cp -r client/dist/* release_package/public/
          
          # C. 复制管理后台资源
          # 注意：根据日志，npm build 输出到了 engine/js/public
          cp -r engine/js/public/* release_package/admin_ui/
          
          # D. 压缩为 tar.gz
          tar -czvf mk48-linux-x64.tar.gz -C release_package .
          echo "打包完成：mk48-linux-x64.tar.gz"

      # --- 4. 发布结果 ---

      # 场景 A: 打标签触发时，创建 Release 并上传
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: mk48-linux-x64.tar.gz
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 场景 B: 手动触发时，作为 Artifact 上传（用于测试）
      - name: Upload Artifact (Manual Test)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: mk48-manual-build
          path: mk48-linux-x64.tar.gz
          retention-days: 3
